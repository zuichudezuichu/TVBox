name: android_build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: 查看代码
        uses: actions/checkout@v4

      # 1. 系统环境准备（源码编译 Python 3.8）
      - name: 安装依赖并编译 Python 3.8
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev \
            libssl-dev libreadline-dev libffi-dev libbz2-dev wget openjdk-11-jdk \
            unzip python3-pip python3-setuptools python3-wheel
          
          # 下载并编译 Python 3.8.19
          wget https://www.python.org/ftp/python/3.8.19/Python-3.8.19.tgz -O /tmp/python38.tgz
          tar -xf /tmp/python38.tgz -C /tmp
          cd /tmp/Python-3.8.19
          ./configure --enable-optimizations --prefix=/usr/local/python38 --with-ensurepip=install
          make -j$(nproc)
          sudo make install
          
          # 创建软链接
          sudo ln -sf /usr/local/python38/bin/python3.8 /usr/bin/python
          sudo ln -sf /usr/local/python38/bin/pip3.8 /usr/bin/pip
          pip install --upgrade pip setuptools wheel
          python --version

      # 2. 配置 JDK 11 环境
      - name: 配置 JDK 11
        run: |
          sudo update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/java-11-openjdk-amd64/bin/javac
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
          echo "GRADLE_OPTS=-Xmx4g -Dorg.gradle.daemon=false" >> $GITHUB_ENV

      # 3. 配置 Android SDK（核心：安装到家目录，避开权限问题）
      - name: 配置 Android SDK 环境（家目录版）
        run: |
          # 核心修改：SDK 安装到 runner 家目录，无需 sudo
          ANDROID_SDK_ROOT="$HOME/android-sdk"
          # 直接创建目录（家目录有完全权限）
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          
          # 下载命令行工具
          wget https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O /tmp/sdk-tools.zip
          unzip -q /tmp/sdk-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
          mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          
          # 配置环境变量（关键：使用家目录路径）
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV
          
          # 接受 SDK 许可（家目录直接创建，无权限问题）
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          
          # 安装 SDK 组件（无需 sudo）
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT --no_https "platforms;android-33" "build-tools;33.0.2" "build-tools;30.0.3" "platform-tools"

      # 4. 克隆项目
      - id: get-project
        name: 读取并克隆项目
        run: |
          if [ ! -f "project-to-build" ]; then
            echo "❌ 未找到 project-to-build 文件"
            exit 1
          fi
          PROJECT_URL=$(cat project-to-build | tr -d ' \n\r')
          rm -rf 项目
          git clone --depth=1 $PROJECT_URL 项目 || { echo "❌ 克隆失败"; exit 1; }

      # 5. 全局替换 Python 路径
      - name: 全局替换 Python 路径（含 pyramid 模块）
        working-directory: ./项目
        run: |
          find . -type f \( -name "build.gradle" -o -name "build.gradle.kts" -o -name "gradle.properties" \) | \
            xargs sed -i 's#D:/Programs/Python/Python38/python.exe#/usr/bin/python#g'
          
          # 核心：local.properties 中使用家目录的 SDK 路径
          cat > local.properties << EOF
          sdk.dir=${{ env.ANDROID_SDK_ROOT }}
          chaquopy.python.buildPython=/usr/bin/python
          chaquopy.python.version=3.8
          org.gradle.java.home=/usr/lib/jvm/java-11-openjdk-amd64
          pyramid.chaquopy.python.buildPython=/usr/bin/python
          EOF
          
          grep -r "D:/Programs/Python/Python38/python.exe" . || echo "✅ 无残留 Windows 路径"

      # 6. 构建 APK + 优化查找逻辑
      - name: 构建应用并查找 APK
        working-directory: ./项目
        run: |
          if [ ! -f "gradlew" ]; then
            gradle wrapper --gradle-version 7.5 --distribution-type bin
          fi
          chmod +x gradlew
          
          ./gradlew assembleNormalDebug --no-daemon --stacktrace --max-workers 1
          
          # 查找 APK
          APK_FILES=$(find . -name "*.apk" -type f | grep -i debug)
          if [ -z "$APK_FILES" ]; then
            APK_FILES=$(find . -name "*.apk" -type f)
          fi
          
          if [ -n "$APK_FILES" ]; then
            echo -e "\n✅ 构建成功！APK 文件："
            ls -lh $APK_FILES
            echo "APK_PATHS=$APK_FILES" >> $GITHUB_ENV
          else
            echo -e "\n❌ 未找到 APK，打印输出目录："
            ls -lh ./app/build/outputs/
            exit 1
          fi

      # 7. 上传 APK
      - name: 上传 APK 到 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-normal-debug-apk
          path: ${{ env.APK_PATHS }}
          retention-days: 14
